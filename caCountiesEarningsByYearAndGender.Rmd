---
title: "Untitled"
author: "Moises Evangelista"
date: "June 1, 2016"
output: pdf_document
---


This report tries to mimic the report [County Pay Practices](https://www.auditor.ca.gov/pdfs/reports/2015-132.pdf)

Issues, a worker may show with two or more times if the worker moved from one position to another or from one department to another with the same title. Some workers change names and may also appear more than once, others leave the department in the middle of the year due to death, retirement, new job in the private sector, etc, while others may start a new job in after the start of the year because they are a new hire or returned to work after leaving. A way to mitiage this would be to add colums that show hours worked, rather than hours vacation, sick time, etc.

```{r setup, include=FALSE}

rm(list=ls(all=TRUE)) #start with empty workspace

knitr::opts_chunk$set(cache = TRUE, echo = FALSE, message = FALSE, warning = FALSE, include = FALSE)

```

## R Markdown

This is an R Markdown document. Markdown is a simple formatting syntax for authoring HTML, PDF, and MS Word documents. For more details on using R Markdown see <http://rmarkdown.rstudio.com>.

When you click the **Knit** b;utton a document will be generated that includes both content as well as the output of any embedded R code chunks within the document. You can embed an R code chunk like this:

```{r loadpackages}

library(data.table)
library(dplyr)
library(tidyr)
library(stringr)
library(babynames)
# library(genderizeR)
library(descr)
library(ggplot2)
library(scales)


```

```{r importdata, cache = TRUE}


CountyData2012 <- fread("http://transparentcalifornia.com/export/2012-counties.csv",
                    stringsAsFactors = TRUE)

CountyData2013 <- fread("http://transparentcalifornia.com/export/2013-counties.csv",
                    stringsAsFactors = TRUE)

CountyData2014 <- fread("http://transparentcalifornia.com/export/2014-counties.csv",
                    stringsAsFactors = TRUE)

CountyData2015 <- fread("http://transparentcalifornia.com/export/2015-counties.csv",
                    stringsAsFactors = TRUE)

CountyData <- rbind(CountyData2012,
                    CountyData2013,
                    CountyData2014,
                    'fill' = TRUE) # County Data for 2015 seems incomplete now
summary(CountyData)


```

```{r cleanUpTheData}
# remove recods where the name is not provided

namesToRemove <- c("Not Provided|Redacted Name Redacted Name|Redacted Redacted|REDACTED REDACTED|Xxx Xxx|Undisclosed|Redact Redact|Undisclosed Undisclosed|Name Withheld Name Withheld|NAME REDACTED|REDACTED|Safety Personnel - Name Redacted|NAME WITHHELD|Exempt From Disclosure")

CountyData <- CountyData %>%
  filter(!grepl(namesToRemove,
                `Employee Name`, ignore.case = TRUE)) %>% 
  filter(`Total Pay & Benefits` > 0) %>%
  droplevels()

summary(CountyData)

# check the names 

CountyData  %>% group_by(`Employee Name`) %>% summarise(count = n()) %>% arrange(desc(count))

listOfNames <- babynames

listOfNamesByGender <- listOfNames %>%
  dplyr::select( name, sex, n) %>% 
  group_by(sex, name) %>% 
  summarise(TotalCount = sum(n)) %>%
  spread(  sex, TotalCount ) %>%
  mutate(TotalCountAllYears =  rowSums(.[2:3], na.rm = TRUE),
         FemalePercent = F/TotalCountAllYears,
         MalePercent = M/TotalCountAllYears) %>%
  dplyr::select(name, FemalePercent, MalePercent)

# remove unnecessary data

rm(list = ls(pattern = "201"))

# now determine names that are both male and female

CountyDataWithGender <- CountyData %>%
  mutate(cleanName =  word(`Employee Name`, 1),
         name = ifelse(grepl(",", `Employee Name`), sub('.*,\\s*', '', `Employee Name`), cleanName),
         name =  word(name, 1),
         name = tolower(name),
         name = gsub("\\b(\\w)", "\\U\\1", name, perl = TRUE),
         name = gsub("[^[:alnum:] ]", "", name)) %>% # head() %>%
  as.data.frame() %>%
  left_join(listOfNamesByGender) %>%
  mutate(FinalGender = ifelse(is.na(FemalePercent) & is.na( MalePercent),"bothMissing",
                              ifelse(is.na(FemalePercent) & !is.na( MalePercent),"MaleLikely", 
                                     ifelse(!is.na(FemalePercent) & is.na( MalePercent),"FemaleLikely", 
                                            ifelse( FemalePercent > MalePercent, "FemaleLikely", "MaleLikely" )))))

# review names that are unknown

MissingNames <- CountyDataWithGender %>% 
  filter(FinalGender == "bothMissing") %>%
  group_by(Agency, `Employee Name`) %>%
  summarise(count = n()) %>%
  ungroup() %>%
  arrange(desc(count))

rm(list = ls(pattern = "listOfNames"))

# calc the median pay by county

CountyDataWithGender <- CountyDataWithGender %>%
  group_by(Agency, Year) %>%
  mutate(medianPay = median(`Total Pay & Benefits`),
         AboveOrBelowMedianPay = ifelse(`Total Pay & Benefits` >=  medianPay ,"above","below"))

```

## Including Plots

You can also embed plots, for example:

```{r pressure, echo=FALSE}

CountyDataWithGender %>%
  group_by(Agency, AboveOrBelowMedianPay,FinalGender) %>%
  summarise(count = n()) %>%
  spread(FinalGender, count)

testData <- CountyDataWithGender %>%
  filter(FinalGender != "bothMissing") %>%
  dplyr::select(Agency, Year, FinalGender, AboveOrBelowMedianPay) %>%
  mutate(AgencyYear = paste0(Agency,"-",Year)) %>% droplevels()

doExpectedValues = function(sel_name) {
  dum = filter(testData, AgencyYear == sel_name) %>% droplevels()

   ct <-  CrossTable(dum$FinalGender, dum$AboveOrBelowMedianPay)
   ctO <- ct$CST$expected
}

testdataExpected <- lapply(unique(testData$AgencyYear), doExpectedValues)

Category_names <- unique(testData$AgencyYear)

# assign  names to list of tables
names(testdataExpected) <- Category_names

testdataExpectedFinal <- testdataExpected %>% # head(1000) %>%
  plyr::ldply(data.frame) %>%
  dplyr::select(AgencyYear = 1, above, below) %>%
  mutate(FinalGender = rep(c("FemaleLikely","MaleLikely"), 150)) %>%
  gather(AboveOrBelowMedianPay, ExpectedCount, -c(AgencyYear, FinalGender))

doExpectedPValues = function(sel_name) {
  dum = filter(testData, AgencyYear == sel_name) %>% droplevels()

   ct <-  CrossTable(dum$FinalGender, dum$AboveOrBelowMedianPay)
   ctO <- ct$CST$p.value
}

testDataPvalues <- lapply(unique(testData$AgencyYear), doExpectedPValues)

# assign names to list of tables
names(testDataPvalues) <- Category_names

testDataPvaluesFinal <- testDataPvalues %>% # head(1000) %>%
  plyr::ldply(data.frame) %>%
  dplyr::select(AgencyYear = 1, pvalue = 2)  %>%
  mutate( pvalue = ifelse(pvalue ==  0,
                          paste0("**",formatC(pvalue, 1, width = 1),"**"),
                          ifelse(pvalue > 0 & pvalue <= 0.05,
                                 paste0("**",formatC(pvalue, 4),"**"),
                                 formatC(pvalue, 4))))
  #mutate(pvalue = trunc(pvalue, 4))

```



```{r tablePvalues2014ByCounty, include=TRUE}

t <-  CountyDataWithGender %>%
  filter(FinalGender != "bothMissing") %>%
  mutate(AgencyYear = paste0(Agency,"-",Year)) %>%
  group_by(AgencyYear, AboveOrBelowMedianPay, FinalGender) %>%
  summarise(ActualCount = n()) %>%
  left_join(testdataExpectedFinal) %>%
  left_join(testDataPvaluesFinal) %>%
  ungroup() %>%
  separate(AgencyYear, c("Agency", "Year"), "-") %>%
  filter(Year == "2014",
         AboveOrBelowMedianPay == "above",
         FinalGender == "FemaleLikely") %>%
  dplyr::select(Agency,  ActualCount, ExpectedCount , pvalue) %>%
  add_rownames( var = "ID") %>%
  droplevels() 

library(pander)

panderOptions('digits', 1)
panderOptions('round', c(0,0,0,0))
panderOptions('keep.trailing.zeros', TRUE)
panderOptions('decimal.mark', ".")
panderOptions('big.mark', ",")
panderOptions('table.split.cells', c(35, 35, 10, 10, 10))

pander(t,
       split.table = Inf,
       caption = "Expected and observed counts for Females for year 2014 by county. Rows where the pvalue is highlighted show a statistical significant difference between pay rate and gender")

```


```{r plotTopCounties, fig.width = 6, fig.height = 9, fig.fullwidth = TRUE, fig.cap= "Top 10 counts by total employees broken down by expected and acutal employees above and below median pay by county and expected counts", message = FALSE, warning = FALSE, include = TRUE, eval = TRUE}

yearFilter = "2014"

Top10ByYear2014 <- CountyDataWithGender %>%
  filter(FinalGender != "bothMissing") %>%
  mutate(AgencyYear = paste0(Agency,"-",Year)) %>%
  group_by(AgencyYear) %>%
  summarise(count = n()) %>%
  ungroup() %>%
  separate(AgencyYear, c("Agency", "Year"), "-") %>%
  #group_by(Agency, Year) %>%
  filter(Year == yearFilter) %>%
  arrange(desc(count)) %>%
  top_n(10)

t <- CountyDataWithGender %>%
  filter(FinalGender != "bothMissing") %>%
  mutate(AgencyYear = paste0(Agency,"-",Year)) %>%
  group_by(AgencyYear, AboveOrBelowMedianPay, FinalGender) %>%
  summarise(ActualCount = n()) %>%
  left_join(testdataExpectedFinal) %>%
  ungroup() %>%
  separate(AgencyYear, c("Agency", "Year"), "-") %>%
  gather(Metric, value, -c(Agency, Year, AboveOrBelowMedianPay, FinalGender)) %>%
 right_join(Top10ByYear2014)

ggplot(t, aes(value, Metric)) +
  geom_point( aes(colour = FinalGender,
                  shape = AboveOrBelowMedianPay),
              alpha = 3/4,
              size = 1) + 
  #facet_wrap(~Agency, scales = "free_x") +
  facet_grid(Agency ~ ., scales = "free_x",  space = "free") + 
  scale_x_continuous(name = "Number of employees (log scale)",
                     trans = log_trans(), 
                     breaks = c(200,2000,10000,20000),
                     labels = comma_format()) +
  theme(        axis.text.x = element_text(size = 5, 
                                           angle = 00,
                                           color = "black", 
                                           hjust = 0),
                axis.text.y  = element_text(size = 5, 
                                            angle = 00,
                                            color = "black", 
                                            hjust = 0),
                strip.text.y = element_text(size = 5,
                                            angle = 0),
                legend.position = "bottom")


```

```{r descriptionTable, eval = FALSE}

library(Hmisc)

t <- CountyDataWithGender %>%
    filter (FinalGender !="bothMissing",
            Year == 2014) %>%
  mutate(AboveOrBelowMedianPay = as.factor(AboveOrBelowMedianPay)) %>% 
  droplevels

DescTable <-  summary(AboveOrBelowMedianPay ~ Agency,
                      data = t, 
                      method="reverse", 
                      test = T, 
                      continuous = 0)

# fuction to take the first row of comment from the latex output

mylatex <- function (...) {
  o <- capture.output(latex(...))
  # this will strip /all/ line-only comments; or if you're only
  #  interested in stripping the first such comment you could
  #  adjust accordingly
  o <- grep('^%', o, inv=T, value=T)
  cat(o, sep='\n')
  }

```




```{r whole county vs target area table, results ='asis', message = FALSE, warning = FALSE, include=TRUE , eval = FALSE}

# render the table

options(digits=1)
mylatex (DescTable, 
         exclude1=FALSE, 
         npct ='numerator', 
         npct.size = "footnotesize", 
         what=c('%'), 
         landscape = FALSE, 
         file = "", 
         long = T, 
         middle.bold=TRUE, 
         longtable = FALSE,
         overall=TRUE, 
         label = "tbl:descTable1",  
         prmsd = TRUE,  
         size="small", 
         caption = "Descriptive statistics by required course status", 
         caption.loc='bottom',
         where="!htbp") # col.just=c("l", "p{3in}")


```


```{r eval= FALSE}

# plot something like this
#  https://learnr.wordpress.com/2009/03/29/ggplot2_marimekko_mosaic_chart/


ggMMplot <- function(var1, var2){
  require(ggplot2)
  levVar1 <- length(levels(var1))
  levVar2 <- length(levels(var2))

  jointTable <- prop.table(table(var1, var2))
  plotData <- as.data.frame(jointTable)
  plotData$marginVar1 <- prop.table(table(var1))
  plotData$var2Height <- plotData$Freq / plotData$marginVar1
  plotData$var1Center <- c(0, cumsum(plotData$marginVar1)[1:levVar1 -1]) +
    plotData$marginVar1 / 2

  ggplot(plotData, aes(var1Center, var2Height)) +
    geom_bar(stat = "identity", aes(width = marginVar1, fill = var2), col = "Black") +
    geom_text(aes(label = as.character(var1), x = var1Center, y = 1.05)) 
  }

ggMMplot(diamonds$cut, diamonds$clarity)



require(ggplot2)
levVar1 <- length(levels(diamonds$cut))
levVar1
levVar2 <- length(levels(diamonds$clarity))
levVar2

jointTable <- prop.table(table(diamonds$cut, diamonds$clarity))
jointTable
plotData <- as.data.frame(jointTable)
plotData
plotData$marginVar1 <- prop.table(table(diamonds$cut))
plotData
plotData$var2Height <- plotData$Freq / plotData$marginVar1
plotData
plotData$var1Center <- c(0, cumsum(plotData$marginVar1)[1:levVar1 -1]) +
  plotData$marginVar1 / 2
plotData

ggplot(plotData, aes(var1Center, var2Height)) +
  geom_bar(stat = "identity", aes(width = marginVar1, fill = diamonds$clarity), col = "Black") +
  geom_text(aes(label = as.character(diamonds$cut), x = var1Center, y = 1.05)) 
}

ggMMplot(diamonds$cut, diamonds$clarity)







```

Note that the `echo = FALSE` parameter was added to the code chunk to prevent printing of the R code that generated the plot.
